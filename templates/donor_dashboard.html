<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor Dashboard - Blood Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand" href="/donor_dashboard">
        <i class="bi bi-droplet-fill me-2"></i>Blood Bank - Donor
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="card shadow">
          <div class="card-body p-5">
            <h2 class="text-danger mb-4 text-center">
              <i class="bi bi-person-heart me-2"></i>Welcome, {{ name }}!
            </h2>
            <p class="lead text-center">As a Donor, you can schedule appointments and track your donations.</p>
            
            <!-- Quick Actions -->
            <div class="row mt-4">
              <div class="col-md-6">
                <div class="card h-100 border-danger">
                  <div class="card-body text-center">
                    <i class="bi bi-calendar-check display-4 text-danger mb-3"></i>
                    <h5>Book Appointment</h5>
                    <p>Schedule your next blood donation.</p>
                    <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#appointmentModal">
                      Book Now
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 border-danger">
                  <div class="card-body text-center">
                    <i class="bi bi-list-check display-4 text-danger mb-3"></i>
                    <h5>My Donations</h5>
                    <p>View your donation history.</p>
                    <button class="btn btn-outline-danger w-100" onclick="loadDonations()">
                      View History
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Donation History Section -->
            <div class="row mt-5">
              <div class="col-12">
                <h4 class="text-danger mb-3"><i class="bi bi-clock-history me-2"></i>My Donation History</h4>
                <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>
                <div id="successAlert" class="alert alert-success d-none" role="alert"></div>
                <div id="donationsSection">
                  <p class="text-muted">Loading your donations...</p>
                  <table class="table table-striped table-hover" id="donationsTable" style="display: none;">
                    <thead class="table-danger">
                      <tr>
                        <th>Date</th>
                        <th>Quantity (Units)</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="donationsBody">
                      <!-- Donations will be populated here -->
                    </tbody>
                  </table>
                  <p id="noDonations" class="text-muted" style="display: none;">No donations yet. Book your first appointment!</p>
                </div>
              </div>
            </div>

            <hr class="my-4">
            <div class="text-center">
              <a href="/appointments" class="btn btn-danger">My Appointments</a>
              <a href="/logout" class="btn btn-secondary ms-2">Logout</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Appointment Booking Modal -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="appointmentModalLabel">
            <i class="bi bi-calendar-plus me-2"></i>Book Appointment
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="appointmentForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="appointmentDate" class="form-label">Date</label>
              <input type="date" id="appointmentDate" class="form-control" required min="{{ today_date }}"> <!-- Min today -->
            </div>
            <div class="mb-3">
              <label for="timeSlot" class="form-label">Time Slot</label>
              <input type="time" id="timeSlot" class="form-control" required> <!-- Or dropdown for slots -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger" id="bookBtn">
              <span class="spinner-border spinner-border-sm d-none me-2" id="bookSpinner" role="status"></span>
              Book Appointment
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userId = {{ user_id }};  // Passed from Flask backend
    const donationsBody = document.getElementById('donationsBody');
    const donationsTable = document.getElementById('donationsTable');
    const noDonations = document.getElementById('noDonations');
    const errorAlert = document.getElementById('errorAlert');
    const successAlert = document.getElementById('successAlert');

    // Show/hide alerts
    function showError(message) {
      errorAlert.textContent = message;
      errorAlert.classList.remove('d-none');
      successAlert.classList.add('d-none');
      setTimeout(() => errorAlert.classList.add('d-none'), 5000);
    }

    function showSuccess(message) {
      successAlert.textContent = message;
      successAlert.classList.remove('d-none');
      errorAlert.classList.add('d-none');
      setTimeout(() => successAlert.classList.add('d-none'), 3000);
    }

    // Load user's donation history
    async function loadDonations() {
      try {
        const res = await axios.get(`/donations?donor_id=${userId}`);
        const donations = res.data;

        if (donations.length === 0) {
          donationsTable.style.display = 'none';
          noDonations.style.display = 'block';
          return;
        }

        noDonations.style.display = 'none';
        donationsTable.style.display = 'table';

        donationsBody.innerHTML = donations.map(donation => `
          <tr>
            <td>${new Date(donation.date).toLocaleDateString()}</td>
            <td>${donation.quantity}</td>
            <td><span class="badge bg-${donation.status === 'Completed' ? 'success' : 'warning'}">${donation.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-danger" onclick="viewDonation(${donation.donation_id})">View</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        showError('Error loading donations: ' + (err.response?.data?.error || 'Try again'));
      }
    }

    // Placeholder for viewing a single donation (expand later, e.g., modal with details)
    function viewDonation(donationId) {
      alert(`Viewing donation ID: ${donationId}`);  // Replace with modal or redirect
    }

    // Book appointment form submission
    document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const date = document.getElementById('appointmentDate').value;
      const timeSlot = document.getElementById('timeSlot').value;
      const bookBtn = document.getElementById('bookBtn');
      const bookSpinner = document.getElementById('bookSpinner');

      if (!date || !timeSlot) {
        showError('Please select a date and time.');
        return;
      }

      // Set loading state
      bookBtn.disabled = true;
      bookSpinner.classList.remove('d-none');
      bookBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Booking...';

      try {
        const res = await axios.post('/appointments', { 
          date, 
          time_slot: timeSlot 
        }, {
          headers: { 'Content-Type': 'application/json' }
        });
        showSuccess(res.data.message || 'Appointment booked successfully!');
        // Close modal and reset form
        const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
        modal.hide();
        document.getElementById('appointmentForm').reset();
        // Optional: Refresh donations if needed (but appointments != donations)
      } catch (err) {
        showError('Booking failed: ' + (err.response?.data?.error || 'Try again'));
      } finally {
        bookBtn.disabled = false;
        bookSpinner.classList.add('d-none');
        bookBtn.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2" id="bookSpinner" role="status"></span>Book Appointment';
      }
    });

    // Load donations on page load
    loadDonations();
  </script>
</body>
</html>