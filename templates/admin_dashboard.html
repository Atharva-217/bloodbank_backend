<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Blood Bank</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <style>
    .card { border-radius: 10px; }
    .table-container { margin-top: 20px; }
    .action-btn { margin-right: 5px; }
    .loading-text { font-style: italic; color: #6c757d; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand" href="/admin_dashboard">
        <i class="bi bi-droplet-fill me-2"></i>Blood Bank - Admin
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-12">
        <div class="card shadow">
          <div class="card-body p-5">
            <h2 class="text-danger mb-4 text-center">
              <i class="bi bi-person-shield me-2"></i>Welcome, {{ name }}! (Admin Panel)
            </h2>
            <p class="lead text-center">Manage users, requests, inventory, and privileges. Data queried transparently from fragmented/replicated views.</p>
            
            <div class="row mt-4 mb-5">
              <div class="col-md-3">
                <div class="card text-white bg-primary">
                  <div class="card-body text-center">
                    <i class="bi bi-people display-4 mb-3"></i>
                    <h5>Total Users</h5>
                    <h3 id="totalUsers">Loading...</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-white bg-warning">
                  <div class="card-body text-center">
                    <i class="bi bi-clipboard-check display-4 mb-3"></i>
                    <h5>Pending Requests</h5>
                    <h3 id="pendingRequests">Loading...</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-white bg-success">
                  <div class="card-body text-center">
                    <i class="bi bi-heart-pulse display-4 mb-3"></i>
                    <h5>Total Donations</h5>
                    <h3 id="totalDonations">Loading...</h3>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-white bg-danger">
                  <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                    <h5>Low Stock Alerts</h5>
                    <h3 id="lowStock">Loading...</h3>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="loadUsers()">
                  <i class="bi bi-people me-2"></i>Refresh Users
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="loadRequests()">
                  <i class="bi bi-clipboard-check me-2"></i>Refresh Requests
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="loadInventory()">
                  <i class="bi bi-boxes me-2"></i>Refresh Inventory
                </button>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#privilegesModal">
                  <i class="bi bi-key me-2"></i>Manage Privileges
                </button>
              </div>
            </div>

            <div class="row table-container">
              <div class="col-12">
                <h4 class="text-danger mb-3"><i class="bi bi-people me-2"></i>All Users (From Fragmented View)</h4>
                <div id="usersSection">
                  <p class="loading-text">Loading users...</p>
                </div>
                <table id="usersTable" class="table table-striped table-hover d-none">
                  <thead class="table-danger">
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Region</th>
                      <th>Blood Group</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="usersBody"></tbody>
                </table>
              </div>
            </div>

            <div class="row table-container">
              <div class="col-12">
                <h4 class="text-danger mb-3"><i class="bi bi-clipboard-check me-2"></i>All Requests (From Fragmented View)</h4>
                <div id="requestsSection">
                  <p class="loading-text">Loading requests...</p>
                </div>
                <table id="requestsTable" class="table table-striped table-hover d-none">
                  <thead class="table-danger">
                    <tr>
                      <th>ID</th>
                      <th>Date</th>
                      <th>Blood Group</th>
                      <th>Units</th>
                      <th>Status</th>
                      <th>Type</th>
                      <th>Recipient ID</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="requestsBody"></tbody>
                </table>
              </div>
            </div>

            <div class="row table-container">
              <div class="col-12">
                <h4 class="text-danger mb-3"><i class="bi bi-database-fill me-2"></i>Inventory (From Replica View)</h4>
                <div id="inventorySection">
                  <p class="loading-text">Loading inventory...</p>
                </div>
                <table id="inventoryTable" class="table table-striped table-hover d-none">
                  <thead class="table-danger">
                    <tr>
                      <th>Blood Group</th>
                      <th>Units</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="inventoryBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fulfill Request Modal -->
  <div class="modal fade" id="fulfillModal" tabindex="-1" aria-labelledby="fulfillModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="fulfillModalLabel">Fulfill Request</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="fulfillForm">
          <div class="modal-body">
            <input type="hidden" id="fulfillRequestId">
            <p id="fulfillDetails" class="mb-3"></p>
            <div class="mb-3">
              <label for="allocatedUnits" class="form-label">Units to Allocate (default: required)</label>
              <input type="number" id="allocatedUnits" class="form-control" min="1" placeholder="Enter units">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Fulfill Request</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Update User Modal -->
  <div class="modal fade" id="updateUserModal" tabindex="-1" aria-labelledby="updateUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="updateUserModalLabel">Update User</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="updateUserForm">
          <div class="modal-body">
            <input type="hidden" id="updateUserId">
            <div class="mb-3">
              <label for="updateRole" class="form-label">Role</label>
              <select id="updateRole" class="form-select">
                <option value="Donor">Donor</option>
                <option value="Recipient">Recipient</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="updateRegion" class="form-label">Region</label>
              <select id="updateRegion" class="form-select">
                <option value="North">North</option>
                <option value="South">South</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Update Inventory Modal -->
  <div class="modal fade" id="updateInventoryModal" tabindex="-1" aria-labelledby="updateInventoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="updateInventoryModalLabel">Update Inventory</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="updateInventoryForm">
          <div class="modal-body">
            <input type="hidden" id="updateBloodType">
            <div class="mb-3">
              <label for="newUnits" class="form-label">New Units</label>
              <input type="number" id="newUnits" class="form-control" min="0" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-info text-white">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Privileges Modal -->
  <div class="modal fade" id="privilegesModal" tabindex="-1" aria-labelledby="privilegesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="privilegesModalLabel">Manage Privileges (Grant/Revoke)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="privilegesForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="privAction" class="form-label">Action</label>
              <select id="privAction" class="form-select">
                <option value="grant">Grant</option>
                <option value="revoke">Revoke</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="privPrivilege" class="form-label">Privilege</label>
              <select id="privPrivilege" class="form-select">
                <option value="SELECT">SELECT</option>
                <option value="INSERT">INSERT</option>
                <option value="UPDATE">UPDATE</option>
                <option value="DELETE">DELETE</option>
                <option value="ALL">ALL</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="privTable" class="form-label">Table/View</label>
              <select id="privTable" class="form-select">
                <option value="all_users">all_users</option>
                <option value="all_requests">all_requests</option>
                <option value="inventory_replica">inventory_replica</option>
                <option value="users_sensitive">users_sensitive</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="privRole" class="form-label">Role</label>
              <select id="privRole" class="form-select">
                <option value="donor_role">donor_role</option>
                <option value="recipient_role">recipient_role</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-warning">Execute</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CDNs: jQuery and DataTables JS first -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- Bootstrap JS next (for modals) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Axios last (for API calls) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- Custom Script -->
  <script>
    console.log('Admin Dashboard script starting for user: {{ user_id | safe }}, Name: {{ name | safe }}');

    let usersTable, requestsTable, inventoryTable;

    const errorAlert = document.getElementById('errorAlert') || createAlert('error');
    const successAlert = document.getElementById('successAlert') || createAlert('success');

    function createAlert(type) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type === 'error' ? 'danger' : 'success'} d-none`;
      alert.id = type === 'error' ? 'errorAlert' : 'successAlert';
      document.querySelector('.card-body').prepend(alert);
      return alert;
    }

    function showError(message) {
      console.error('ERROR:', message);
      errorAlert.textContent = message;
      errorAlert.classList.remove('d-none');
      setTimeout(() => errorAlert.classList.add('d-none'), 5000);
    }

    function showSuccess(message) {
      console.log('SUCCESS:', message);
      successAlert.textContent = message;
      successAlert.classList.remove('d-none');
      setTimeout(() => successAlert.classList.add('d-none'), 3000);
    }

    // Load Stats
    window.loadStats = async function() {
      console.log('Starting loadStats...');
      try {
        const res = await axios.get('/admin/stats');
        console.log('Stats data:', res.data);
        document.getElementById('totalUsers').textContent = res.data.total_users || 0;
        document.getElementById('pendingRequests').textContent = res.data.pending_requests || 0;
        document.getElementById('totalDonations').textContent = res.data.total_donations || 0;
        document.getElementById('lowStock').textContent = res.data.low_stock || 0;
        showSuccess('Stats loaded.');
      } catch (err) {
        console.error('Stats Error:', err);
        const msg = err.response?.status === 404 ? 'Admin stats endpoint not found' : err.response?.data?.error || err.message;
        showError('Error loading stats: ' + msg);
      }
    };

    // Load Users
    window.loadUsers = async function() {
        console.log('Starting loadUsers...');
        const section = document.getElementById('usersSection');
        const table = document.getElementById('usersTable');
        const tbody = document.getElementById('usersBody');
        section.innerHTML = '<p class="loading-text">Loading users...</p>';
        table.classList.add('d-none');
    
        try {
            const res = await axios.get('/admin/users');
            console.log('Users data:', res.data);
            const users = res.data;
    
            if (users.length === 0) {
                section.innerHTML = '<p class="text-muted">No users found.</p>';
                return;
            }
    
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.user_id}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td><span class="badge bg-${u.role === 'Admin' ? 'danger' : u.role === 'Donor' ? 'primary' : 'secondary'}">${u.role}</span></td>
                    <td><span class="badge bg-info">${u.region}</span></td>
                    <td>${u.blood_group || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary action-btn" onclick="updateUser(${u.user_id}, '${u.role}', '${u.region}')">Edit</button>
                        <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteUser(${u.user_id})">Delete</button>
                    </td>
                </tr>
            `).join('');
    
            table.classList.remove('d-none');
            section.innerHTML = '';  // Clear loading text
    
            if ($.fn.DataTable.isDataTable('#usersTable')) {
                $('#usersTable').DataTable().destroy();
            }
            usersTable = $('#usersTable').DataTable({
                "pageLength": 10,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "order": [[0, "desc"]]
            });
    
            showSuccess(`Loaded ${users.length} users from fragmented view.`);
    
        } catch (err) {
            console.error('Users Error:', err);
            const status = err.response?.status || 0;
            let msg = err.response?.data?.error || err.message;
            if (status === 404) msg = 'Admin users endpoint not found (add /admin/users route to app.py)';
            else if (status === 403) msg = 'Access denied - Admin role required';
            section.innerHTML = `<p class="alert alert-danger">Error loading users: ${msg}</p>`;
            showError('Failed to load users: ' + msg);
        }
    };
    

  // Load Requests
  window.loadRequests = async function() {
    console.log('Starting loadRequests...');
    const section = document.getElementById('requestsSection');
    const table = document.getElementById('requestsTable');
    const tbody = document.getElementById('requestsBody');
    section.innerHTML = '<p class="loading-text">Loading requests...</p>';
    table.classList.add('d-none');

    try {
      const res = await axios.get('/admin/requests');
      console.log('Requests data:', res.data);
      const requests = res.data;

      if (requests.length === 0) {
        section.innerHTML = '<p class="text-muted">No requests found.</p>';
        return;
      }

      tbody.innerHTML = requests.map(r => `
        <tr>
          <td>${r.request_id}</td>
          <td>${new Date(r.date).toLocaleDateString()}</td>
          <td>${r.blood_group}</td>
          <td>${r.required_units}</td>
          <td><span class="badge bg-${r.status === 'Fulfilled' ? 'success' : r.status === 'Pending' ? 'warning' : 'secondary'}">${r.status}</span></td>
          <td><span class="badge bg-info">${r.request_type}</span></td>
          <td>${r.recipient_id}</td>
          <td>
            ${r.status === 'Pending' ? `<button class="btn btn-sm btn-success action-btn" onclick="fulfillRequest(${r.request_id}, '${r.blood_group}', ${r.required_units})">Fulfill</button>` : ''}
            <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteRequest(${r.request_id})">Delete</button>
          </td>
        </tr>
      `).join('');

      table.classList.remove('d-none');
      section.innerHTML = '';  // Clear loading
      if ($.fn.DataTable.isDataTable('#requestsTable')) {
        $('#requestsTable').DataTable().destroy();
      }
      requestsTable = $('#requestsTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "order": [[1, "desc"]]  // Date descending
      });
      showSuccess(`Loaded ${requests.length} requests from fragmented view.`);
    } catch (err) {
      console.error('Requests Error:', err);
      const status = err.response?.status || 0;
      let msg = err.response?.data?.error || err.message;
      if (status === 404) msg = 'Admin requests endpoint not found (add /admin/requests route to app.py)';
      else if (status === 403) msg = 'Access denied - Admin role required';
      section.innerHTML = `<p class="alert alert-danger">Error loading requests: ${msg}</p>`;
      showError('Failed to load requests: ' + msg);
    }
  };

  // Load Inventory
  window.loadInventory = async function() {
    console.log('Starting loadInventory...');
    const section = document.getElementById('inventorySection');
    const table = document.getElementById('inventoryTable');
    const tbody = document.getElementById('inventoryBody');
    section.innerHTML = '<p class="loading-text">Loading inventory...</p>';
    table.classList.add('d-none');

    try {
      const res = await axios.get('/inventory');  // Use existing /inventory (replica view)
      console.log('Inventory data:', res.data);
      const inventory = res.data;

      if (inventory.length === 0) {
        section.innerHTML = '<p class="text-muted">No inventory found.</p>';
        return;
      }

      tbody.innerHTML = inventory.map(item => `
        <tr class="${item.units < 10 ? 'table-warning' : ''}">
          <td>${item.blood_type}</td>
          <td>${item.units}</td>
          <td><span class="badge ${item.units < 10 ? 'bg-warning' : 'bg-success'}">${item.units < 10 ? 'Low Stock' : 'Available'}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-info action-btn" onclick="updateInventory('${item.blood_type}', ${item.units})">Update</button>
          </td>
        </tr>
      `).join('');

      table.classList.remove('d-none');
      section.innerHTML = '';  // Clear loading
      if ($.fn.DataTable.isDataTable('#inventoryTable')) {
        $('#inventoryTable').DataTable().destroy();
      }
      inventoryTable = $('#inventoryTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "order": [[1, "desc"]]  // Units descending
      });
      showSuccess(`Loaded ${inventory.length} inventory items from replica view.`);
    } catch (err) {
      console.error('Inventory Error:', err);
      const status = err.response?.status || 0;
      let msg = err.response?.data?.error || err.message;
      if (status === 404) msg = 'Inventory endpoint not found (add /inventory route to app.py)';
      else if (status === 403) msg = 'Access denied - Admin role required';
      section.innerHTML = `<p class="alert alert-danger">Error loading inventory: ${msg}</p>`;
      showError('Failed to load inventory: ' + msg);
    }
  };

  // Update User (Open Modal)
  window.updateUser = function(userId, currentRole, currentRegion) {
    console.log('Updating user:', userId);
    document.getElementById('updateUserId').value = userId;
    document.getElementById('updateRole').value = currentRole;
    document.getElementById('updateRegion').value = currentRegion;
    new bootstrap.Modal(document.getElementById('updateUserModal')).show();
  };

  // Delete User
  window.deleteUser = async function(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    console.log('Deleting user:', userId);
    try {
      const res = await axios.delete(`/admin/users/${userId}`);
      showSuccess(res.data.message);
      loadUsers();  // Refresh table
    } catch (err) {
      showError('Error deleting user: ' + (err.response?.data?.error || err.message));
    }
  };

  // Fulfill Request (Open Modal)
  window.fulfillRequest = function(requestId, bloodGroup, requiredUnits) {
    console.log('Fulfilling request:', requestId);
    document.getElementById('fulfillRequestId').value = requestId;
    document.getElementById('fulfillDetails').innerHTML = `
      <strong>Blood Group:</strong> ${bloodGroup}<br>
      <strong>Required Units:</strong> ${requiredUnits}
    `;
    document.getElementById('allocatedUnits').value = requiredUnits;  // Default to required
    new bootstrap.Modal(document.getElementById('fulfillModal')).show();
  };

  // Delete Request
  window.deleteRequest = async function(requestId) {
    if (!confirm('Are you sure you want to delete this request?')) return;
    console.log('Deleting request:', requestId);
    try {
      const res = await axios.delete(`/admin/requests/${requestId}`);  // Assume route exists
      showSuccess(res.data.message || 'Request deleted.');
      loadRequests();  // Refresh
    } catch (err) {
      showError('Error deleting request: ' + (err.response?.data?.error || err.message));
    }
  };

  // Update Inventory (Open Modal)
  window.updateInventory = function(bloodType, currentUnits) {
    console.log('Updating inventory for:', bloodType);
    document.getElementById('updateBloodType').value = bloodType;
    document.getElementById('newUnits').value = currentUnits;
    new bootstrap.Modal(document.getElementById('updateInventoryModal')).show();
  };

  // DOM Ready - Define everything and auto-load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - Defining functions and auto-loading...');
    
    // Load stats first
    loadStats();

    // Auto-load tables
    loadUsers();
    loadRequests();
    loadInventory();

    console.log('Script loaded successfully - All functions defined.');

    // Event Listeners for Modals (after DOM ready)
    // Fulfill Form
    document.getElementById('fulfillForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const requestId = document.getElementById('fulfillRequestId').value;
      const allocatedUnits = parseInt(document.getElementById('allocatedUnits').value) || 0;
      console.log('Submitting fulfill for request:', requestId, 'Units:', allocatedUnits);
      try {
        const res = await axios.post(`/admin/fulfill/${requestId}`, { allocated_units: allocatedUnits });
        showSuccess(res.data.message);
        bootstrap.Modal.getInstance(document.getElementById('fulfillModal')).hide();
        loadRequests();  // Refresh table
        loadInventory();  // Refresh stock
      } catch (err) {
        showError('Error fulfilling request: ' + (err.response?.data?.error || err.message));
      }
    });


    // Update User Form
    document.getElementById('updateUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const userId = document.getElementById('updateUserId').value;
      const role = document.getElementById('updateRole').value;
      const region = document.getElementById('updateRegion').value;
      console.log('Updating user:', userId, 'Role:', role, 'Region:', region);
      try {
        const res = await axios.put(`/admin/users/${userId}`, { role, region });
        showSuccess(res.data.message);
        bootstrap.Modal.getInstance(document.getElementById('updateUserModal')).hide();
        loadUsers();  // Refresh table
      } catch (err) {
        showError('Error updating user: ' + (err.response?.data?.error || err.message));
      }
    });

    // Update Inventory Form
    document.getElementById('updateInventoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const bloodType = document.getElementById('updateBloodType').value;
      const newUnits = parseInt(document.getElementById('newUnits').value);
      console.log('Updating inventory:', bloodType, 'to', newUnits);
      try {
        const res = await axios.post('/admin/inventory', { blood_type: bloodType, new_units: newUnits });
        showSuccess(res.data.message);
        bootstrap.Modal.getInstance(document.getElementById('updateInventoryModal')).hide();
        loadInventory();  // Refresh table
      } catch (err) {
        showError('Error updating inventory: ' + (err.response?.data?.error || err.message));
      }
    });

    // Privileges Form
    document.getElementById('privilegesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const action = document.getElementById('privAction').value;
      const privilege = document.getElementById('privPrivilege').value;
      const table = document.getElementById('privTable').value;
      const role = document.getElementById('privRole').value;
      console.log('Executing privilege:', action, privilege, 'on', table, 'to', role);
      try {
        const res = await axios.post('/admin/privileges', { action, privilege, table, role });
        showSuccess(res.data.message);
        bootstrap.Modal.getInstance(document.getElementById('privilegesModal')).hide();
      } catch (err) {
        showError('Error executing privilege: ' + (err.response?.data?.error || err.message));
      }
    });
  });
</script>
</body>
</html>